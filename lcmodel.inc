C
CIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
C
C  Must have: 
C    MMETAB .GE. 2,
C    MWFFTC=MAX0(4*MDATA+15,MBACKG**2), 
C    MCPY=MAX0(MDATA,MBACKG,4*MSIDES+2), 
C    MCHCOM=MIN0(56,MCOMPO*(MCHMET+1)),
C    MCHLIN .GE. 1
C    MDATA .GE. MSIDES
C
c  Change to lcmodel-big.inc (for Roche):
c      PARAMETER (MUNFIL=32768, MDATA=2*MUNFIL, MY=13000, 
c     2           MMETAB=180, 
c
c  Change to LCModel 6.2-0B: MY=13000(4000); --> 59(22)MB; see Notes 071120
c  Change to LCModel 6.2-0D: MY=20000; --> 84MB 
c
c  ' MY=' and ' MUNFIL=' must be unique, so that Makefile will work in 
c     reducing array sizes for SGI.
c
      PARAMETER (MMETAB=100, 
     1           MUNFIL=65536, 
     1           MDATA=2*MUNFIL, 
     1           MY=12000, 
     2           mmeta1=mmetab-1, mmeta2=mmetab-2, MMETA3=MMETAB-3, 
     2           MMET13=MMETAB-13, MMET14=MMETAB-14, 
     2           mmetab_extra=5*mmetab, 
     2           mmet_ex2=mmetab_extra-2, mmet_ex3=mmetab_extra-3, 
     2           mmet_ex14=mmetab_extra-14, mmet_ex33=mmetab_extra-33, 
     2           MPMET=100, MPMET6=MPMET-6, MPMET16=MPMET-16, 
     2           MPME55=MPMET-55, 
     2           mmpowr=3, mcoeff_power=mmpowr*mmetab, 
     2           mgau=20, mmet_mgau=mmetab*mgau, 
     2           MBACKG=100, MSIDES=20, MINCSD=20, MSHIFT=25, 
     3           MWFFTC=4*MDATA+15, MCPY=MDATA,
     4           MREFPK=10, MREFP1=MREFPK-1, MREFP4=MREFPK-4, 
     4           MREFP6=MREFPK-6, 
     5           MNONL=2*(MMETAB+MSIDES+1), 
     6           MREGF=2*MSIDES+3, 
     7           MPAR=(mmpowr+2)*MMETAB+MBACKG+2*MSIDES+3,
     7           mgroup_shift=40, 
     8     MROW=MY+(mmpowr+mgroup_shift+3)*MMETAB+MNONL+MBACKG+MREGF+3, 
     9           MCOMPO=50, MCONC=MMETAB+MPMET, 
     B           MCHFIL=255, MCHFMT=80, MCHID=20, MCHMET=6, 
     C           MCHCOM=350, MKEY=64, MDEV=32, 
     D           MCHLIN=74, MLINES=500, 
     E           MSTAGE=3, MMERMS=9000, MMERM9=MMERMS+9, mvoxel=65536, 
     f           mmet_ratio=30, mchratio=1+(mchmet+1)*mmet_ratio,
     g           mchsimul=528, mvoxsk=64, mgap=10, mmdegp3=51, 
     h           mchgam=16, mdwork_finout=2*msides+4+mnonl)
      CHARACTER CHANGE(MLINES, 2)*(MCHLIN), chbcal*(mchmet), 
     1	        chcali(mmetab)*(mchmet), chcol*9, 
     1          CHCOMB(MPMET)*(MCHCOM), CHCOM2(MPMET)*(MCHCOM), 
     1          CHDATE*33, CHERR(MMERM9)*6, CHEXT2(MMETAB)*(MCHMET), 
     1          chgam*(mchgam), chgrsh(mgroup_shift)*(mchmet), 
     1          CHKEEP(MMETAB_EXTRA)*(MCHMET), chless(mmetab)*6, 
     1          chline*132, chlsha(MMETAB)*(MCHMET), chmore*6, 
     1          chnols(MMETAB_EXTRA)*(MCHMET), 
     1          chnot1(mmetab_extra)*(mchmet), 
     1          chnot2(mmetab_extra)*(mchmet), 
     1          CHOMIT(MPMET)*(MCHMET), CHPMET(MPMET)*(MCHMET), 
     1          chrati(mmetab)*(mchratio), chrato(mmetab)*(264), 
     1          chratw(mmetab)*(mchratio), chrow*9, 
     1          CHSDSH(MMETAB)*(MCHMET), 
     1          CHSDT2(MMETAB)*(MCHMET), chsim(mmetab)*(mchmet), 
     1          chsimu(mmetab)*(mchsimul), chslic*9, CHSUBP*6, 
     1          CHUSE1(MMETAB_EXTRA)*(MCHMET), ERRORS(MMERM9)*(MCHLIN), 
     1          ETCOUT(MLINES)*(MCHLIN), FILBAS*(MCHFIL), 
     1          FILCOO*(MCHFIL), FILCOr*(MCHFIL), 
     1          filcsi_sav_1*(mchfil), filcsi_sav_2*(mchfil), 
     1          FILcsv*(MCHFIL), FILH2O*(MCHFIL), 
     1          FILPRI*(MCHFIL), FILPS*(MCHFIL), FILRAW*(MCHFIL), 
     1          FILTAB*(MCHFIL),
     1          NACOMB(MCONC)*(MCHCOM), NACOM2(MCONC)*(MCHCOM), 
     1          NAMEAC(MMETAB)*(mchmet), 
     1          NAMREL*(MCHCOM), norato(mmetab)*(mchmet), 
     1          OWNER*120, OWNOUT*129, PGNORM*2, 
     1          savdir*(mchfil), SEQ_raw*5, sptype*16, srch2o*(mchfil), 
     1          srcraw*(mchfil), SYNUS1(2,MPMET)*(MCHMET), 
     1          TABLE(MCONC+1, 2)*(MCHLIN), TITLE*244, 
     1          title_line(2)*122, VERSIO*120, version_lcm*16,
     1          wsmet*(mchmet)
      COMMON /BLCHAR/ CHANGE, chbcal, chcali, chcol, 
     1                CHCOMB, chcom2, 
     1                CHDATE, CHERR, CHEXT2, chgam, 
     1                chgrsh, CHKEEP, chless, chline, 
     1                chlsha, chmore, chnols, chnot1, chnot2,
     1                CHOMIT, CHPMET, chrati, chrato, 
     1                chratw, chrow, CHSDSH, CHSDT2, 
     1                chsim, chsimu, chslic, CHUSE1, ERRORS, 
     1                ETCOUT, FILBAS, FILCOO, filcor, 
     1                filcsi_sav_1, filcsi_sav_2, 
     1                filcsv, FILH2O, FILPRI, 
     1                FILPS, FILRAW, FILTAB, 
     1                NACOMB, nacom2, NAMEAC, NAMREL, norato, 
     1                OWNER, OWNOUT, PGNORM, 
     1                savdir, SEQ_raw, sptype, srch2o, srcraw, 
     1                SYNUS1, TABLE, TITLE, title_line, VERSIO, 
     1                version_lcm, wsmet
      COMPLEX BASIST(MDATA,MMETAB), CTERM(3), CY(MY), 
     1        cy_sav(my, mmdegp3+7), DATAF(MDATA), 
     1        DATAT(mdata), datat_work(munfil), 
     1        H2OF(MDATA), h2of_work(mdata), 
     1        H2OT(MDATA), H2OT_work(MDATA)
      COMMON /BLCPLX/ BASIST, CTERM, CY, cy_sav, DATAF, DATAT, 
     1                datat_work, H2OF, h2of_work, 
     1                H2OT
      DOUBLE PRECISION ALPBBS(mmdegp3+7), 
     2                 ALPBMN, ALPBMX, ALPHAB, ALPHAS, 
     2                 ALPSBS(mmdegp3+7), 
     2                 ALPSMN, ALPSMX, coeff_power_sd(mmpowr, mmetab), 
     2                 DAMAT(MROW,MPAR), 
     2                 DGAUSS(0:2*MSIDES+4), 
     2                 DPARMQ(MNONL), DPY(4*MSIDES+10), DRANGE, DSSQ, 
     2                 DTERM(3), DWFFTC(mwfftc), GRAD(MNONL), 
     2                 OBJECT, OBJLIN, 
     2                 PARBES(MNONL,mmdegp3+7), PARNLN(MNONL), 
     2                 PAROLD(MNONL), PENBES(mmdegp3+7), 
     2                 PMQBES(mmdegp3+7), PMQSAV, power(mmpowr), 
     2                 PRECIS, REGF(MREGF,2*MSIDES), 
     2                 SDBEST(mmdegp3+7), SDREF, 
     2                 SOLBES(MPAR,mmdegp3+7), SOLUTN(MPAR), STDDEV, 
     2                 tpower(mmpowr, mdata)
      COMMON /BLDP/ ALPBBS, ALPBMN, ALPBMX, ALPHAB, ALPHAS, ALPSBS, 
     2              ALPSMN, ALPSMX, coeff_power_sd, 
     2              DAMAT, DGAUSS, DPARMQ, DPY, 
     2              DRANGE, DSSQ, DTERM, DWFFTC, GRAD, OBJECT, 
     2              OBJLIN, PARBES, PARNLN, PAROLD, PENBES, PMQBES, 
     2              PMQSAV, power, PRECIS, REGF, SDBEST, SDREF, SOLBES, 
     2              SOLUTN, STDDEV, tpower
      COMMON /BLINT/ iareaw, iauto, iaverg, 
     3               icolen, icolsk(mvoxsk), 
     3               icolst, iconc_line_table(mconc), 
     3               idcol, idgppm, idrow, idslic, 
     3               IDUMP(MSTAGE), IERRNO(MMERM9), IETCOU, IKNTMN, 
     3               imethd, INCSID, INCSMX, INDCOL(MPAR), 
     3               ioffset_current_in, IPAGE2, 
     3               IPCERR(MCONC+1), ipdump, ipowph, ipowrg, irowen, 
     3               irowsk(mvoxsk), irowst, 
     3               ISDBOL, ISHIFD, ISHIFW, islice, 
     3               ISTAGO, iter_dump, KEY(MKEY), KNUM(3), LBASIS, 
     3               LCOMPO(MCOMPO,MCONC), LCONTR, 
     3               lcontr_scratch, LCOORD, 
     3               lcoraw, lcsi_sav_1, lcsi_sav_2, lcsv, LDATEN, 
     3               LDATST, LDEV1(MDEV), LDWFFT, LETT, LEVERR(MMERM9), 
     3               LH2O, LINCHG(2), LINERR, linerr_mycont, 
     3               LINETC, LINTBL, 
     3               lmetab_prior(mmetab), 
     3               lmetab_shift_prior(mmetab*mgroup_shift), LPHAST, 
     3               lpowen(0:mmetab), 
     3               LPRINT, LPS, LRAW, LRT2ST, LSHIST, 
     3               LTABLE, LWFFT, 
     3               MDALPB, mdegp3, MERMES, MFNDAL, MINTER(3), 
     3               MITER(3), mnsamp, mpower, 
     3               MREPHA(2), nback(2), 
     3               NBACKG, nbas_ccf, nbckmn, ncalib, nchgam, 
     3               nchles, nchlin(2), NCOMBI, 
     3               NCOMPO(MCONC), NCONC, NDATA, ndcols, 
     3               ndegppm3_used, NDEGZ(2), NDF, 
     3               NDFREF, NDGPPM(2), ndrows, ndslic, 
     3               NEACH, nermes, NERROR(MMERM9), NEXPON, 
     3               NEXTR(2), NEXT2, ngap, ngau(mmetab), ngrsh, 
     3               n1hmet, NINFL(2), NKEEP, NLIN, 
     3               nlines_title, nlshap, 
     3               NMETAB, nnolsh, NNONL, nnorat, 
     3               nnot1, nnot2, NOMIT, NPAR, npower(mmetab), 
     3               nratio, nratio_used, NREFPK(2), NREGF, 
     3               NRF2MN, NROWDA, nrow_group_shift, 
     3               NSDSH, NSDT2, NSHIFT, NSIDES, 
     3               NSIDE2, NSIDMN, NSIDMX, 
     3               nsimul, NSUBTK, ntable_top, ntitle, NUNFIL, NUSE1, 
     3               nvoxsk, nwsend, nwsst, NY, nyuse
      LOGICAL absval, accept_alpbmn, accept_step2, 
     4        areaba_orig_basisf, asymlp, badref, bascal, basout, 
     4        biglip, CCNTRL, chksim, 
     4        conc3f, DOECC, doecc_active, 
     4        DOFULL, DOREFS(2), dowatr, dows,
     4        DOZERO(3), eccdon, endpha, fixshf, forecc, 
     4        fwhmba_in_control, FXDEGP, FXDEGZ, 
     4        gauss_rt2, gshgua, 
     4        havh2o, INISOL, initialize_solve, is_alpbmn, LANDSC, 
     4        lcy_skip(my), ldump(10), LLINE, 
     4        lraw_at_top, lshape(mmetab), 
     4        nobase, nobasi, NOLIne, 
     4        NONNEG(MPAR), omit_chless, onlyco, 
     4        PLPRFT, ratio_outlier(mconc+1), 
     4        QUICK, reflac, roomt, scafwh, 
     4        scasim, sidump(mmetab), single_voxel, 
     4        sitayl(mmetab), skip_step3, skip_voxel, smtail, solgrd, 
     4        SUBBAS, table_top(mconc), unsupr, usemxb, useany, useglc,
     4        USINFL, VITRO, voxel1, wsdone, year4d, zero_voxel(mvoxel)
      COMMON /BLLOG/ absval, accept_alpbmn, accept_step2, 
     4               areaba_orig_basisf, asymlp, badref, 
     4               bascal, basout, biglip, CCNTRL, 
     4               chksim, conc3f, 
     4               DOECC, doecc_active, DOFULL, DOREFS, dowatr, dows, 
     4               DOZERO, eccdon, endpha, fixshf, forecc, 
     4               fwhmba_in_control, FXDEGP, FXDEGZ, 
     4               gauss_rt2, gshgua, havh2o, 
     4               INISOL, initialize_solve, is_alpbmn, LANDSC, 
     4               lcy_skip, ldump, LLINE, 
     4               lraw_at_top, lshape, nobase, nobasi, 
     4               NOLIne, NONNEG, omit_chless, onlyco, 
     4               PLPRFT, ratio_outlier, 
     4               QUICK, reflac, roomt, scafwh, 
     4               scasim, sidump, single_voxel,
     4               sitayl, skip_step3, skip_voxel, smtail, solgrd, 
     4               SUBBAS, table_top, unsupr, usemxb, useany, useglc, 
     4               USINFL, VITRO, voxel1, wsdone, year4d, zero_voxel
      COMMON /BLREAL/ ALEXT2(MMETAB), ALOG2, ALPBPN, 
     5 alpb_degp(0:mmdegp3), ALPBST, 
     5 alphab_dump, alphas_dump, ALPSST, 
     5 ALSDSH(MMETAB), ALSDT2(MMETAB), area_met_norm, atth2o, attmet, 
     5 BACKGR(MY,MBACKG), BACKRE(MY), black(3), bwtolr, 
     5 cgroup_shift(mmetab*mgroup_shift, mmetab), 
     5 CONCEN(MCONC), conc_expect(mmetab), CONREL, COSMIN(3), 
     5 cprior(mmetab,mmetab), CPY(MCPY), daimbs, ddegp3, DDGPMQ(2), 
     5 DDGZMQ(2), DEEXT2, DEGMAX(2), 
     5 degp_degp(0:mmdegp3), DEGPPM, DEGZER, DELPPM(MY), 
     5 DELTAT, DESDSH, DESDT2, DFLDMQ, DGPPMN, dgppmn_orig, 
     5 DGPPMX, dgppmx_orig, 
     5 dist_degp(0:mmdegp3), dkngam, DKNTMN(2), 
     5 dkntmn_standard, DSHPAT(2,2), echot, ECHOT_raw, 
     5 EXDEGP, EXDEGZ, 
     5 exrati(mmetab), 
     5 EXRT2(MMETAB), fcalib, fconc_expect, fcsum, 
     5 FH2OMX, fmain_power, FNDATA, 
     5 fother_power, fract_power_sd(mmpowr, mmetab), 
     5 frepha, FSTPMQ, FWHH2O, FWHMBA, fwhmmn, fwhmmx, 
     5 fwhmsm, 
     5 FWHMST, fwhmst_full, hifmm, hwdwat(2), hzpgam(2), 
     5 HZPPPM, hzpppm_raw, HZREF(MREFPK,2), PAGEHT, PAGEWD, 
     5 phi_plot(2), 
     5 PHITOT(2), phitot_sav(mmdegp3+7, 2), 
     5 PI, PMQST(3), PMQSTL(3), PNALPB, PPM(MY), 
     5 ppmbas(2), PPMCEN, PPMEND, 
     5 ppmend_phalip, ppmgap(2, mgap), ppmh2o, 
     5 PPMINC, PPMMET(4,MPMET), 
     5 PPMPOS(2), PPMREF(MREFPK,2), ppmsep(mgap), PPMSHF, ppmsig(2), 
     5 ppmst, ppmst_phalip, ppm_truncate_max, ppm_truncate_min, 
     5 ppm_water_range, ppm_water_tol, 
     5 PRMNMX(2,3), PTLABL, PTOUTP, PTTITL, PTVERS, 
     5 RADIAN, RALIMN, RALINC, r_areaba, ratipm, RBACKG(2), 
     5 rbasmx(2), RCONVR(3), RDALPB, 
     5 REGB(MBACKG,MBACKG), rfwbas, 
     5 RFWHCC, RFWHM, rfwhmst_ccf, RFWHST, RGBBOL(3), rgberr(3), 
     5 RGBLIN(3,6), rgbrat(3), 
     5 RHLABL, RHOUTP, RHTITL, RHVERS, RINCRS(3), rincsh, rlesmo, 
     5 rlrntz, RMQDEC(3), RMQINC(2,3), RMSAMP, 
     5 RPENMX, RPMQMN(3), rpowmq, RRANGE, 
     5 RRT2MQ, rsdgp3, rsdsam(3), rsdsmq, 
     5 RSHFMQ, RSTPMN(3), RSTPMX(3), rt2min(mmetab), RWFONT, 
     5 rwork(mdata), rwork2(mdata), sddegp, sddegp_input, sddegz, 
     5 sdgroup_shift_row(mmetab*mgroup_shift), 
     5 sdgrsh(mgroup_shift), SDMSHF, sdrati(mmetab), 
     5 SDRT2(MMETAB), SDSHIF(MMETAB), sdshmn, sdshmx, 
     5 SDSMOO(4), SHIFMN(2), shifmn_orig(2),
     5 SHIFMX(2), shifmx_orig(2), siamp(mgau,mmetab), sifwex(mmetab), 
     5 sifwmn(mgau,mmetab), sifwsd(mmetab), sippm(mgau,mmetab), 
     5 sisdsh(mmetab), sqrtwt_ratio_used(mmetab), SSQAIM, 
     5 SSQBES(mmdegp3+7), ssqbes_degp, 
     5 ssq_degp(0:mmdegp3), SSQMAX, SSQMIN, SSQREF, temm, THRLIN, 
     5 TOFWHM, WDLINE(6), XLEFT, XRIGHT, XSTEP, wconc, WFFTC(MWFFTC), 
     5 wsppm, XTRPMX, YFITRE(MY,0:MMETAB), YBOTT, YREAL(MY), YTOP
C     -------------------------------------------------------------------------
C     The variables specified above are global (except for CHSUBP).
C     -------------------------------------------------------------------------
